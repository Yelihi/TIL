## cookie의 구성과 자바스크립트로 조작하기

<p>브라우저 내 application > cookie 를 자바스크립트로 직접 조작하는것은 사실 좋은것은 아니다. 자바스크립트를 통해 조작이 가능하다면, 해커가 이를 접근해서 악용할 수 있기 때문이다. 처음 서버에서 쿠키를 전송할 때 만료일자를 설정할 수 있고, 이 만료일자를 통해서 쿠키를 자연스럽게 삭제하는 방향을 주로 사용하곤 한다.</p><br />

<p>그럼에도 상황에 따라 쿠키를 제어할 수 있어야 하고, 아직까지 쿠키를 다루는 데 있어서 모르는 부분이 많다보니, 우선 자바스크립트내에서 쿠키를 다루는 방법을 한번 학습해보자</p>

### Cookie 구성

<p>위에서 쿠키의 역할에 대해서 간략하게 설명하였었으니, 자바스크립트내에서 쿠키를 생성하는 방향과 각각의 속성들에 대해서 살펴보자</p>

```js
Document.cookie =
  "Name=value; Expire=날짜; Domain=도메인; Path=경로; max-age=초; secure";
```

- Name
  - Name은 데이터 쿠키의 이름이며 반드시 지정을 해주어야 한다.(생성할때는)
- Expire
  - 쿠키의 파기 날짜를 지정하는 속성이다. 이 속성에는 GMT나 UTC 형식으로 날짜를 입력해야 한다.
  - 이 날짜를 입력하지 않으면 브라우저가 종료될 때 쿠키가 삭제된다.
  - 반대로 날짜를 설정해놓으면 브라우저을 껏다가 다시 켜도 쿠키가 유지된다.
- max-age
  - expire의 보완버전이자 만료되기까지의 시간을 정할 수 있다.
  - 초 단위로 예를 들어 10을 작성하면, 쿠키가 10초 되 파기된다는 의미이다.
  - 만약 0이나 음수를 입력하면 그 즉시 쿠키가 파기된다.
- Secure
  - 이 속성을 지정하면 쿠키는 SSL을 사용해서만 요청할 수 있다.(즉, https 를 써야만)
- Domain
  - 기본값으로는 현재 도메인의 경로로 자동 입력된다
  - 페이지 요청과 비교하여 도메인의 경로와 Domain 의 속성이 일치하지않으면, 쿠키에 접근하는 것을 막으므로 Domain 속성은 건드리지 않는다.
- Path 속성
  - 이 속성을 입력하지않으면 현제 도메인 경로로 자동 입력된다
  - 이 속성은 /폴더/ 로 설정되는데, 이렇게 설정하면 이 폴더부터 하위까지 접근이 가능하다.
  - path 속성을 / 으로 하면 도메인 내 모든 곳에서 접근할 수 있다.
  - 예를 들어 /admin 을 설정해놓으면 이 path 와 그 하위는 쿠키에 접근할 수 있지만, /home 과 같이 다른 path 에서는 접근할 수 없다.
  - 그래서 그냥 / 을 하는게 편하다

<p>즉, 어떠한 이벤트에 의해 쿠키를 삭제하고 싶다면 아래와 같이 작성하면 된다.</p>

```js
document.cookie = "name=; max-age=-1; path=/";
```

- 여기서 path 는 사용자에 따라 다르게 지정하면 된다.

<p>참고로 쿠키를 생성할때는 형식의 유효성을 일관성있게 유지하기 위해 내장함수를 사용하자</p>

```js
let name = "my name";
let value = "wonik";

document.cookie = encodeURIComponent(name) + "=" + encodeURIComponent(value);
```

<p>이 외에도 특정 속성들이 있는데, 주로 보안과 관련된 속성들이다</p>

### samesite

<p>예를 들어서 은행 사이트 bank.com 에 로그인한 상태라고 생각해보자. 은행 서비스를 이용하다가 새로운 창을 여러서 다른 웹서핑을 하던 도중 evil.com 에 접속했다고 가정하자. 이 악의에 찬 사이트는 자동적으로 해커에서 송금을 요구하는 form 이 있고, 자동으로 제출되도록 설정되어있다. 이 form 은 action으로 bank.com/pay 로 되어있어 evil.com -> bank.com 으로 바로 전송이 되게 된다. 이때 bank.com 에 접근할 때 브라우저에 있는 쿠키도 같이 전송되게 된다. 왜냐하면 로그인이 되어있었으니깐. 은행은 이를 모르고 실제 해커에게 돈을 송금하게 됩니다.</p>

<p>이러한 공격을 크로스 사이트 요청 위조(XSRF)라고 한다. 보통 bank에는 이에 대한 대비책으로 XSRF 보호 토큰을 가지고 있다. 이 토큰은 악의적인 페이지에서 만들 수 없고 훔칠수도 없게 설계되어있어서 이 토큰이 없다면 요청이 의미없어지게되니 이러한 공격을 막을 수 있다. 다만 구현에도 시간이 걸리고 모든 요청에 대해서 검수를 해야하니, 우선적으로 브라우저에서 차단하는 방법이 있다. 그것이 samesite 속성이다.</p>

- samesite=strict 옵션을 이용하면, 사용자가 외부에서 요청을 보낼 때, 이 옵션이 있는 쿠키는 절대로 전송되지 않는다.
- 즉 제 3의 도메인에서 요청이 이뤄질 땐 쿠키가 전송되지 않는다.
- 쿠키가 전송이 안되니 당연히 송금 요청도 이뤄지지 않게 된다.
- 다만 예를 들어 어떠한 메모장에 링크를 옮겨놓고, 추후에 그 링크를 통해 bank.com 을 접속할 때, samesite 설정에 의해 쿠키가 전송되지 않게될 수 있다.
- 방법이라면 일반 인증용 쿠키를 설정하고, 데이터 교환시 사용하는 쿠키를 따로 두는 방식이 있다.

<p>이러한 samesite 의 문제점은 오래된 브라우저(2017년 이전버전)에서는 지원하지 않는다는 점이다. 그래서 이것만 믿고 보안 처리를 하면 문제가 발생할 수 있다.</p>

### httpOnly

<p>이번에 쿠키를 설정하면서 false 로 설정해두었던 속성이다. 이 속성이 true 이면(디폴트값) 자바스크립트에서 쿠키에 접근할 수 없다. 즉, 위에서 설정하는 document.cookie 를 통해서 접근이 불가능하다는 의미. 이를 통해 해커가 자바스크립트로 쿠키에 접근하는것을 사전에 막을 수 있다. 반대로 말하자면 왠만하면 이 속성은 true 로 해두는것이 좋다는 의미.</p>
